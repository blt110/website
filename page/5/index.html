<!doctype html><html><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.1">
<link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css integrity=sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk crossorigin=anonymous>
<link rel=stylesheet href=/css/code_tango.css>
<script src=https://code.jquery.com/jquery-3.5.1.slim.min.js integrity=sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js integrity=sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js integrity=sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI crossorigin=anonymous></script>
<link href=https://cdnjs.cloudflare.com/ajax/libs/fotorama/4.6.4/fotorama.css rel=stylesheet>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fotorama/4.6.4/fotorama.js></script>
<link rel=apple-touch-icon sizes=180x180 href=https://www.scottyob.com/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://www.scottyob.com/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://www.scottyob.com/favicon-16x16.png>
<link rel=manifest href=https://www.scottyob.com/site.webmanifest>
<link rel=mask-icon href=https://www.scottyob.com/safari-pinned-tab.svg color>
<meta name=msapplication-TileColor content>
<meta name=theme-color content>
<link rel=stylesheet href=https://www.scottyob.com/css/bootstrap.min.css>
<title>Home | Scott O'Brien</title>
<style>@media(min-width:992px){.container{max-width:850px}}body{background-color:#fff;background-color:#fff;color:#888;font-size:.66em;font-family:lucida grande,Verdana,Arial,Sans-Serif;line-height:1.4;margin:0;padding:0}.header{margin:4em 0}@media(min-width:768px){#sidebar{text-align:right}}#sidebar{text-transform:lowercase}#sidebar h2{font-family:lucida grande,Verdana,Arial,Sans-Serif;font-size:1.2em;text-transform:uppercase;margin:0;padding:.5em 0 .4em}#sidebar ul{list-style-type:none;margin:0;padding:0}#sidebar li:before{content:"\00BB  "}a{color:#ff7010;text-decoration:none}h1{font-size 3.2em;line-height:1em}h2{font-size:1.8em}h1,h2,h3,h4,h5{font-family:trebuchet ms,lucida grande,Verdana,Arial,Sans-Serif;font-weight:700;line-height:normal;margin:0;padding:0}small{font-size:1em;line-height:1.5em;background-color:inherit;color:#888}h2.pagetitle{background-color:#f0f0f0;color:inherit;padding:.5em 0 .4em .2em;margin:0 0 2em}#content{color:#484848}.leftnav{float:left;margin:0 1em}.rightnav{float:right}.snap-to-fit{clear:both;visibility:hidden}.navigation{margin:0 0 1.6em;padding:0 0 1px;font-family:lucida grande,Arial,Verdana,Sans-Serif;font-size:1.2em}.post{margin:0 0 3em}.post+.post h2{padding:.2em 0 0;border-top:1px solid #888}.entry{width:100%;font-size:1.2em;margin:1em 0 0;overflow:auto}blockquote{margin:1.6em 2.8em 0 1.4em;padding:0 0 0 2em;border-left:.6em solid #ddd}#footer{clear:both;margin:4em 0 1em;padding:.2em 0 0;border-top:1px solid #888;font-family:lucida grande,Arial,Verdana,Sans-Serif}</style>
</head>
<body><div id=navbar-top class=d-md-none>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
<a class=navbar-brand href=/>Posts</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarNavAltMarkup aria-controls=navbarNavAltMarkup aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarNavAltMarkup>
<div class=navbar-nav>
<a class="nav-item nav-link" href=/page/bucketlist/>The Bucket List</a>
<a class="nav-item nav-link" href=/page/about/>About Me</a>
</div>
</div>
</nav>
</div>
<div class=container id=container>
<div class=row>
<div class="col-md-9 offset-md-3">
<div class=header>
<h1><a href=/>Scott O'Brien</a></h1>
<small>Ramblings and resources of my online life</small>
</div>
</div>
</div>
<div class=row>
<div id=content class=col-md-9>
<div class=navigation>
<div class=leftnav>« <a href=/page/4/>Later Posts</a></div>
<div class=snap-to-fit></div>
</div>
<div class=post>
<h2 class=post__title>
<a href=https://www.scottyob.com/2011/07/02/whats-the-harm-in-google-dns-performance/>What’s the harm in Google DNS?Performance!</a>
</h2>
<small>2011-07-02 14:40:05 +0000 UTC</small>
<div class=entry>
<p><strong>EDIT:  </strong>It looks like Google has recently starting peering in more places in AU with an anycast solution that fixes these issues.</p>
<p>On a little side note to the tutorial series I’ve been writing up lately for building a ZFS fileserver. This one is about Why Google DNS is bad for your performance (well, depending on where you live)
A real quick run down, we all know what DNS does yeah? It translates domains like <a href=http://www.scottyob.com>www.scottyob.com</a> into IP addresses like 112.140.183.97. A DNS server has a job of translating these domain names to the IP addresses we can use.</p>
<p>Now, when it comes to Google DNS, if you believe in the propaganda <a href=http://code.google.com/speed/public-dns/ onclick="_gaq.push(['_trackEvent','outbound-article','http://code.google.com'])"><a href=http://code.google.com/speed/public-dns/>http://code.google.com/speed/public-dns/</a></a> where Google DNS is said to</p>
<ul>
<li><a href=http://code.google.com/speed/public-dns/docs/performance.html onclick="_gaq.push(['_trackEvent','outbound-article','http://code.google.com'])">Speed up your browsing experience</a></li>
<li><a href=http://code.google.com/speed/public-dns/docs/security.html onclick="_gaq.push(['_trackEvent','outbound-article','http://code.google.com'])">Improve your Security. </a></li>
</ul>
<p>What google doesn’t tell you is that it interferes with DNS servers that might try and give you a server that’s close to your home. I’ve been using Google DNS for months here at home, but only just have I decided against using it, and I’ll run through exactly what causes some performance issues.</p>
<p>I was trying to watch a program on iView on TPG’s internet connection. Now, TPG don’t have the best international links on peak times, so I first started getting frustrated at them for not letting me watch my iView program with buffer lags on my 8Mbit plan. I checked my Signal to Noise ratio and dropped packets, etc.. it was fine. I checked the bandwith going out on my ppp interface on the router to see if I was maxing out the net connection at home, but nope, that was fine too, so the problem must have been with TPG.</p>
<p>Looking at what was going on, I did a little traceroute to <a href=http://www.abc.net.au>www.abc.net.au</a></p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>traceroute: Warning: www.abc.net.au has multiple addresses; using 125.252.224.73
 traceroute to a1632.g.akamai.net (125.252.224.73), 64 hops max, 52 byte packets
 1 10.1.1.254 (10.1.1.254) 1.919 ms 1.260 ms 1.202 ms
 2 * * *
 3 202.7.173.17 (202.7.173.17) 27.056 ms 26.317 ms 26.693 ms
 4 syd-sot-ken-crt1-ge-5-1-0.tpgi.com.au (202.7.162.173) 26.283 ms 26.884 ms 26.100 ms
 5 ix-11-1-0-507.tcore2.tv2-tokyo.as6453.net (116.0.88.21) 153.325 ms 135.736 ms 126.568 ms
 6 if-14-0-0-1720.core1.tv2-tokyo.as6453.net (209.58.61.121) 1481.461 ms
 if-1-0-0-1715.core1.tv2-tokyo.as6453.net (209.58.61.125) 298.270 ms
 if-14-0-0-1720.core1.tv2-tokyo.as6453.net (209.58.61.121) 282.141 ms
 7 if-10-0-0-981.core3.hk2-hongkong.as6453.net (116.0.82.85) 208.232 ms
 if-5-0-0.core3.hk2-hongkong.as6453.net (116.0.82.1) 199.170 ms
 if-10-0-0-981.core3.hk2-hongkong.as6453.net (116.0.82.85) 206.027 ms
 8 vlan31.icore1.hk2-hongkong.as6453.net (116.0.82.18) 219.937 ms 204.963 ms 196.273 ms
 9 80.150.169.25 (80.150.169.25) 333.519 ms 306.138 ms 307.031 ms
 10 80.156.224.6 (80.156.224.6) 358.402 ms 320.029 ms 349.133 ms
 11 a125-252-224-73.deploy.akamaitechnologies.com (125.252.224.73) 332.188 ms 331.008 ms 314.833 ms
</code></pre></td></tr></table>
</div>
</div><p>Looking at this traceroute, the first thing I thought was “Why on earth is ABC hosting it’s website in hongkong (or so the traffic has to go via hongkong.)? Immediately reject ABC would do this and I blame TPG’s stupid routing decisions.
Looking at the IP address further <a href="http://www.dnsstuff.com/tools/ipall/?tool_id=67&token=&toolhandler_redirect=0&ip=125.252.224.73" onclick="_gaq.push(['_trackEvent','outbound-article','http://www.dnsstuff.com'])"><a href="http://www.dnsstuff.com/tools/ipall/?tool_id=67&token=&toolhandler_redirect=0&ip=125.252.224.73">http://www.dnsstuff.com/tools/ipall/?tool_id=67&token=&toolhandler_redirect=0&ip=125.252.224.73</a></a> It looks like it’s hosted in Singapore, and some googling shows akamaitechnologies is the web host for ABC.. ok, so what is going on here?</p>
<p>then I did a little DIGging around on the ABC domain and check this out.</p>
<p>Using Google DNS (8.8.8.8, hosted in America):</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>; &lt;&lt;&gt;&gt; DiG 9.6.0-APPLE-P2 &lt;&lt;&gt;&gt; www.abc.net.au @8.8.8.8
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 16084
;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;www.abc.net.au. IN A
;; ANSWER SECTION:
www.abc.net.au. 882 IN CNAME www.abc.net.au.edgesuite.net.
www.abc.net.au.edgesuite.net. 21581 IN CNAME a1632.g.akamai.net.
a1632.g.akamai.net. 2 IN A 63.150.131.41
a1632.g.akamai.net. 2 IN A 63.150.131.33
;; Query time: 161 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Sun Jul 3 00:37:00 2011
;; MSG SIZE rcvd: 135
</code></pre></td></tr></table>
</div>
</div><p>And using TPG’s DNS servers (203.12.160.35)</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>; &lt;&lt;&gt;&gt; DiG 9.6.0-APPLE-P2 &lt;&lt;&gt;&gt; www.abc.net.au @203.12.160.35
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 11673
;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;www.abc.net.au. IN A
;; ANSWER SECTION:
www.abc.net.au. 523 IN CNAME www.abc.net.au.edgesuite.net.
www.abc.net.au.edgesuite.net. 12274 IN CNAME a1632.g.akamai.net.
a1632.g.akamai.net. 10 IN A 202.7.177.66
a1632.g.akamai.net. 10 IN A 202.7.177.83
;; Query time: 29 msec
;; SERVER: 203.12.160.35#53(203.12.160.35)
;; WHEN: Sun Jul  3 00:38:20 2011
;; MSG SIZE  rcvd: 135
</code></pre></td></tr></table>
</div>
</div><p>So there we go, hosted in Sydney Australia.. So how does the traceroute compare?</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>macshell:~ scott$ traceroute www.abc.net.au
traceroute: Warning: www.abc.net.au has multiple addresses; using 202.7.177.83
traceroute to a1632.g.akamai.net (202.7.177.83), 64 hops max, 52 byte packets
1  10.1.1.254 (10.1.1.254)  1.711 ms  1.134 ms  1.100 ms
2  * * *
3  202.7.173.17 (202.7.173.17)  27.047 ms  26.072 ms  26.502 ms
4  syd-sot-ken-ak2-83.tpgi.com.au (202.7.177.83)  26.540 ms  26.835 ms  26.540 ms
</code></pre></td></tr></table>
</div>
</div><p>Different nameservers can be set up to resolve to different addresses based on geographic positioning, in more of a first in best dressed kind of effort.  So if you’re using Google DNS servers (8.8.8.8), it so happens that because this is in America (check out their IP address, CA), then I started getting update servers and the like on DNS that were closest in latency terms to America then Sydney Australia.
Simply by changing from Google DNS servers to my ISP’s, I get healthier latency, and am no longer sending traffic over saturated overseas links.  So how does this compare with ABC iView?</p>
</div>
</div>
<div class=post>
<h2 class=post__title>
<a href=https://www.scottyob.com/2011/04/04/allowing-access-through-nfs-samba/>Allowing access through NFS & SAMBA</a>
</h2>
<small>2011-04-04 11:53:32 +0000 UTC</small>
<div class=entry>
<h2 id=heading></h2>
<h2>
Cifs Share
</h2>
<p>CIFS (Common Internet File System), the protocol windows users for all it’s ‘windows file sharing’ is the method I’ll allow for my desktops and roaming computers to access files on the file server.</p>
<p>Before we begin, Make sure we install the CIFS kernal modules</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># pkg install SUNWsmbs # pkg install SUNWsmbskr
</code></pre></td></tr></table>
</div>
</div><p>next we issue this command to make sure it auto starts</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># svcadm enable -r smb/server
</code></pre></td></tr></table>
</div>
</div><p>I’ve decided for every day use, I want a data store on the server, so..</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># zfs create datastore/homes # zfs create datastore/homes/scott
</code></pre></td></tr></table>
</div>
</div><p>now, set up compression on my home directory</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># zfs set compression=on datastore/homes
</code></pre></td></tr></table>
</div>
</div><p>Time to do some setup so we can log into this share, I’ll make the box join the workgroup ‘home</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># smbadm join -w home
</code></pre></td></tr></table>
</div>
</div><p>To start sharing with windows boxes, I need to change the pam.conf file to generate windows passwords too. Add the line below /etc/pam.conf</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>other password required pam_smb_passwd.so.1 nowarn
</code></pre></td></tr></table>
</div>
</div><p>reset the password for my user scott, then I’ll be able to authenticate with him</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># passwd scott
</code></pre></td></tr></table>
</div>
</div><p>The next step is setting up guest access. You may remember we created a media share datastore/media. We want to share that with guests to the network (on the trusted subnet anyway). Before we go ahead and set that up, we want to map the windows Guest user to the unix user nobody.</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># idmap add winname:Guest unixuser:nobody
</code></pre></td></tr></table>
</div>
</div><p>then we’ll allow guest access to our media box</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># zfs set sharesmb=name=media,guestok=true datastore/media
</code></pre></td></tr></table>
</div>
</div><p>I also want to make my home directory only accessible by me, so I’m going to own the directory</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>chown scott /datastore/homes/scott chgrp staff /datastore/homes/scott chmod 700 /datastore/homes/scott
</code></pre></td></tr></table>
</div>
</div><p>and share it</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># zfs set sharesmb=name=scott datastore/homes/scott
</code></pre></td></tr></table>
</div>
</div><p>So there we have it, a media folder anyone can access, and a ‘scott’ share that I’ll need to authenticate with (HOME\scott user)</p>
<p><a href=/img/old/2011/03/image1.png onclick="_gaq.push(['_trackEvent','outbound-article','http://www.scottyob.com'])" class=image-link><img src=/img/old/2011/03/image_thumb1.png height=355 width=480 style="text-align:center;display:block;margin:0 auto 10px"></a></p>
<h2>
NFS Shares
</h2>
<p>Now we’ve got CIFS set up for our clients, I want to set up NFS shares for other Linux boxes on the network (at this point, only my router) to be able to access. The idea is that my router will have all the home directories on the FileServer (so it’ll get the advantages of snapshots, etc) we well as not being limited to the dying 60GB hard disk for torrenting and such things.</p>
<p>As mentioned, I’m only interested in NFS shares with my router at this point, so we’ll make sure my routers IP address (10.12.1.254) is restricted in the shares.</p>
<p>The first thing we want to try is setting up the nfs mount on our homes directory.</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># zfs set &lt;a href=&#34;mailto:sharenfs=root=@10.12.1.254,rw=@10.12.1.254&#34;&gt;sharenfs=root=@10.12.1.254,rw=@10.12.1.254&lt;/a&gt; datastore/homes
</code></pre></td></tr></table>
</div>
</div><p>Now, <strong>on my debian router box</strong> I want to see if I can mount this (assuming the directory /home2/scott exists on the client)</p>
<p>sudo mount -t nfs -o nfsvers=3 10.12.1.1:/datastore/homes/scott /home2/scott</p>
<p>and Ta-Da! My home directory is mounted. What I want to do now is to set up auto-mounts. That is, when a directory is accessed for my users home directory, it’d mount it on the fly.</p>
<p>First, install the autofs package</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>apt-get install autofs
</code></pre></td></tr></table>
</div>
</div><p>Add the following line into <strong>/etc/auto.master</strong></p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>/home2 /etc/auto.home -–timeout=60
</code></pre></td></tr></table>
</div>
</div><p>and the following into the file <strong>/etc/auto.home</strong></p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>* -fstype=nfs,rw,nosuid,soft,vers=3 server:/datastore/homes/&amp;#038;
</code></pre></td></tr></table>
</div>
</div><p>the <strong>*</strong> and /datastore/homes/� do their magic by automatically mounting the required directory when needed (as long as the /etc/init.d/autofs is started)</p>
<p>Now lets add a place for our downloads</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># zfs create datastore/media/downloads # zfs set sharenfs=root=router,rw=router datastore/media/downloads
</code></pre></td></tr></table>
</div>
</div><p>I chose to just mount this using the automounter under the home2 directory, I added this to the <strong>/etc/auto.home</strong> file</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>downloads -fstype=nfs,rw,nosuid,soft,vers=3 10.12.1.1:/datastore/media/downloads
</code></pre></td></tr></table>
</div>
</div><p>Pretty neat, now when you head to a directory that’s not mounted yet (like /home2/scott/) in the linux client, it will auto mount the required NFS volume and presto, we’ve got ourselves network storage.
<strong>Other posts to come in the series:</strong><br>1. Selecting the hardware<br>2. Installing the Operating System<br>3. Setting up File systems � Snapshots<br>4. Allowing access through NFS � SAMBA<br>5. Setting up encrypted off-site backups<br>6. Configuring Windows � Linux clients to dump backup info to the FileServer<br>7. My router setup, configuring IP tables � torrents on a low-powered server.
<br class=final-break style=clear:both></p>
</div>
</div>
<div class=post>
<h2 class=post__title>
<a href=https://www.scottyob.com/2011/03/24/3-setting-up-filesystems-and-snapshots-part-2/>3. Setting up FileSystems and Snapshots (part 2)</a>
</h2>
<small>2011-03-24 18:17:20 +0000 UTC</small>
<div class=entry>
<p><strong>Note: This post is one in a series aimed to be a tutorial eventually, it’s not currently finalised and at the moment exists as a place for collating thought and collecting feedback</strong></p>
<p>In <a href="http://www.scottyob.com/?p=88" onclick="_gaq.push(['_trackEvent','outbound-article','http://www.scottyob.com'])">part 1</a> of this blog post, I showed you how I created a script that would, when run, rotate your snapshots on a ZFS filesystem. For this to be usable, we need to create a mechanism for having it be automatically ran. We’ll do this with a cronjob.</p>
<p>On Unix systems, the cron daemon is used to execute scheduled commands. Picture it much like windows task scheduler for all you windows kiddies.</p>
<p>I saved the backup script we wrote yesterday to /FileStore/backups.sh. The first thing I want to get running is my hourly backups. To do this, we’ll start editing our cron file</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>  
    sudo crontab -e
  
</code></pre></td></tr></table>
</div>
</div><p>The crontab utility is a program used to edit the tables that drive the cron daemon.</p>
<p>On my OSX box, information about how to set up the cron file can be found in ‘man 5 crontab’</p>
<p>Basically, cron examines cron entries once every minute. the fields that we’ve got to play with are (in this order)</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>  
    field allowed values&lt;br /&gt; &amp;#8212;&amp;#8211; &amp;#8212;&amp;#8212;&amp;#8212;&amp;#8212;&amp;#8211;&lt;br /&gt; minute 0-59&lt;br /&gt; hour 0-23&lt;br /&gt; day of month 1-31&lt;br /&gt; month 1-12 (or names, see below)&lt;br /&gt; day of week 0-7 (0 or 7 is Sun, or use names)
  
</code></pre></td></tr></table>
</div>
</div><p>Having said that, it’s time to think about when we want to create our snapshots. Because I intend machines to do their backups to the server on the hour, I’ll be creating my snapshots at half past the hour. My cron file now looks like this (for hourly snapshots with 24 rotations, daily snapshots with 7 rotations, Weekly snapshots with 4 rotations.</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>  
    #**Snapshots for the Filesystem**&lt;br /&gt;30 * * * * /bin/bash /FileSystem/backups.sh hourly 24&lt;br /&gt;30 6 * * * /bin/bash /FileSystem/backups.sh daily 7&lt;br /&gt;30 6 * * sun /bin/bash /FileSystem/backups.sh weekly 4
  
</code></pre></td></tr></table>
</div>
</div><p>Now that that concludes our section on setting up my rotating snapshots.</p>
<p><strong>Other posts to come in the series:<br></strong>1. Selecting the hardware<br>2. Installing the Operating System<br>3. Setting up File systems � Snapshots<br>4. Allowing access through NFS � SAMBA<br>5. Setting up encrypted off-site backups<br>6. Configuring Windows � Linux clients to dump backup info to the FileServer<br>7. My router setup, configuring IP tables � torrents on a low-powered server.</p>
<p><br class=final-break style=clear:both></p>
</div>
</div>
<div class=post>
<h2 class=post__title>
<a href=https://www.scottyob.com/2011/03/18/3-setting-up-filesystems-and-snapshots/>3. Setting up FileSystems and Snapshots (part 1)</a>
</h2>
<small>2011-03-18 12:10:36 +0000 UTC</small>
<div class=entry>
<p><strong><em>Note: This post is one in a series aimed to be a tutorial eventually, it’s not currently finalised and at the moment exists as a place for collating thought and collecting feedback</em></strong></p>
<p>Setting up the FileSystems is a trivial task.  First, you can see that when we’ve created a storage pool ‘datastore’ it created a filesystem for us (also called datastore) that can act as a container for child file systems.  I’m going to go ahead and create a place to store my media and downloads now</p>
<blockquote>
<p>zfs create datastore/media</p>
</blockquote>
<p>for now I’ll also want a place to store my backups.  It’s worth noting that while my media filesystem will contain compressed MP3’s and the like, it’s kind of a waste of CPU power to compress it, but my backups will be a lot of PHP pages and what not, so lets go ahead and enable compression on this one</p>
<blockquote>
<p># zfs create datastore/backups</p>
</blockquote>
<blockquote>
<p># zfs set compression=on datastore/backups</p>
</blockquote>
<p>As appalled as I am of my mums backup habits, one of the requirements of this server was to provide a medium for backing up her data without her having to do anything, so lets set up backup locations for my laptop (MacShell) and a place for mum (mum) assigning both of these 20GB quota’s (ok, MacShell gets 120GB)</p>
<blockquote>
<p># zfs create datastore/backups/MacShell</p>
</blockquote>
<blockquote>
<p># zfs create datastore/backups/mum</p>
</blockquote>
<blockquote>
<p># zfs set quota=120G datastore/backups/MacShell</p>
</blockquote>
<blockquote>
<p># zfs set quota=20GB datastore/backups/mum</p>
</blockquote>
<blockquote>
<p># zfs get datastore/backups/mum</p>
</blockquote>
<p>Now, the idea is that a cron job will run rsyncing over the files every hour, on the hour.  For many reasons (in case I get a virus and need to revert back, in case somebody hacks in and does bad stuff, etc, etc) I’m going to choose to <a href=http://docs.huihoo.com/opensolaris/solaris-zfs-administration-guide/html/ch06.html onclick="_gaq.push(['_trackEvent','outbound-article','http://docs.huihoo.com'])">create Snapshots</a> so I can roll back to a previous version.</p>
<p>The convention I want is hourly.HOUR, daily.DAY, weekly.WEEK for up to 7 days and 4 weeks.  This also means that once I delete a file, I won’t recover the space that it took (once a snapshot of the file has been created) in my data pool until the end of the 4 week period.  for instance, hourly.0 will be the last hours snapshot, hourly.1 will be the 2nd last hours snapshot, etc.</p>
<p>the following bash script will take care of the desired snapshots.  It’s based on a concept I took from this <a href=http://blogs.sun.com/mmusante/entry/rolling_snapshots_made_easy onclick="_gaq.push(['_trackEvent','outbound-article','http://blogs.sun.com'])">rolling snapshots made easy</a> post but I like <a href=/img/old/2011/03/snapshot.sh onclick="_gaq.push(['_trackEvent','outbound-article','http://www.scottyob.com'])">my scripted way of doing rotating snapshots</a> much better.</p>
<blockquote>
<p>#!/bin/bash</p>
<p>#print out usage</p>
</blockquote>
<blockquote>
<p>if [ $# -ne 2 ]</p>
</blockquote>
<blockquote>
<p>then</p>
</blockquote>
<blockquote>
<p>echo “Usage: snapshot.sh [snapName] [max]”</p>
</blockquote>
<blockquote>
<p>echo ”  eg. snapshot.sh hour 24″</p>
</blockquote>
<blockquote>
<p>fi</p>
<p>#if the max snapshot already exists, just delete it</p>
</blockquote>
<blockquote>
<p>if [ `zfs list -t snapshot | grep datastore@$1.$2 | wc -l` -eq 1 ]</p>
</blockquote>
<blockquote>
<p>then</p>
</blockquote>
<blockquote>
<p>zfs destroy -r datastore@$1.$2</p>
</blockquote>
<blockquote>
<p>fi</p>
<h1 id=heading></h1>
</blockquote>
<blockquote>
<p>for ((i=$2-1; i >= 0; i–)); do</p>
</blockquote>
<blockquote>
<p>if [ `zfs list -t snapshot | grep datastore@$1.$i | wc -l` -eq 1 ]</p>
</blockquote>
<blockquote>
<p>then</p>
</blockquote>
<blockquote>
<p>#this snapshot exists, so we want to move it up one</p>
</blockquote>
<blockquote>
<p>zfs rename -r datastore@$1.$i @$1.$[$i+1]</p>
</blockquote>
<blockquote>
<p>fi</p>
</blockquote>
<blockquote>
<p>done</p>
<p>zfs snapshot -r datastore@$1.0</p>
</blockquote>
<p>so with this snapshot beauty in place, lets say I had an existing file and structure in place</p>
<blockquote>
<p>root@thumper:/datastore/backups/MacShell# pwd</p>
</blockquote>
<blockquote>
<p>/datastore/backups/MacShell</p>
</blockquote>
<blockquote>
<p>root@thumper:/datastore/backups/MacShell# tree</p>
</blockquote>
<blockquote>
<p>.</p>
</blockquote>
<blockquote>
<p>|– hello_world.txt</p>
</blockquote>
<blockquote>
<p>`– someDir</p>
</blockquote>
<blockquote>
<p>`– someFile.dat</p>
<p>1 directory, 2 files</p>
</blockquote>
<p>BUT, I had a snapshot in place</p>
<blockquote>
<p># /snapshot.sh hourly 24</p>
</blockquote>
<p>then I did something silly like delete my entire backup directory (Oh No!!)</p>
<blockquote>
<p># rm -R *</p>
</blockquote>
<blockquote>
<p># ls -l</p>
</blockquote>
<blockquote>
<p>total 0</p>
</blockquote>
<p>never fear! check the snapshots</p>
<blockquote>
<p>root@thumper:/datastore/backups/</p>
</blockquote>
<blockquote>
<p>MacShell/.zfs/snapshot/hourly.0# tree</p>
</blockquote>
<blockquote>
<p>.</p>
</blockquote>
<blockquote>
<p>|– hello_world.txt</p>
</blockquote>
<blockquote>
<p>`– someDir</p>
</blockquote>
<blockquote>
<p>`– someFile.dat</p>
</blockquote>
<p>they’ll eventually roll off my snapshot cycle and be removed in 4 weeks with my plan, but hey, pretty good at this point 🙂</p>
<p>See <a href="http://www.scottyob.com/?p=96" onclick="_gaq.push(['_trackEvent','outbound-article','http://www.scottyob.com'])">Part 2</a> for a post on how to set up cron jobs to automatically call this script</p>
<p>**Other posts to come in the series:</p>
<p>** 1. Selecting the hardware</p>
<ol start=2>
<li>
<p>Installing the Operating System</p>
</li>
<li>
<p>Setting up File systems & Snapshots</p>
</li>
<li>
<p>Allowing access through NFS & SAMBA</p>
</li>
<li>
<p>Setting up encrypted off-site backups</p>
</li>
<li>
<p>Configuring Windows & Linux clients to dump backup info to the FileServer</p>
</li>
<li>
<p>My router setup, configuring IP tables & torrents on a low-powered server.</p>
</li>
</ol>
</div>
</div>
<div class=navigation>
<div class=rightnav><a href=/page/6/>Earlier Posts</a> »</div>
<div class=snap-to-fit></div>
</div>
<div id=footer>
Made with <a href=https://gohugo.io/>Hugo</a>. Theme half-milk inspired by <a href=http://thortz.com/skimmed-milk/>skimmed-milk</a>
</div>
</div>
<div id=sidebar class="col-md-3 order-md-first d-none d-md-block">
<h2>Other Pages</h2>
<ul>
<li><a href=/page/bucketlist/>The Bucket List</a></li>
<li><a href=/page/about/>About Me</a></li>
</ul>
</div>
</div>
</div>
</body>
</html>