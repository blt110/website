<!DOCTYPE html>
<html><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.71.1" />

  

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/code_tango.css">
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>


  
  <link rel="apple-touch-icon" sizes="180x180" href="https://www.scottyob.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://www.scottyob.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://www.scottyob.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://www.scottyob.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://www.scottyob.com/safari-pinned-tab.svg" color="">

  <meta name="msapplication-TileColor" content="">

  <meta name="theme-color" content="">

  
  <link rel="stylesheet" href="https://www.scottyob.com/css/bootstrap.min.css" />

  
  
  
  <title>Home | Scott O&#39;Brien</title>
  

  <style>

  @media (min-width: 992px){
    .container{
      max-width:850px;
    }  
  }

  body {
    background-color: #fff;
    background-color: #fff;
    color: #888;
    font-size: .66em;
    font-family: lucida grande,Verdana,Arial,Sans-Serif;
    line-height: 1.4;
    margin: 0;
    padding: 0;
  }

  .header {
    margin: 4em 0;
  }

  @media (min-width: 768px) {
    #sidebar {
      text-align: right;
    }
  }

  #sidebar {
    text-transform: lowercase;
  }

  #sidebar h2 {
    font-family: lucida grande, Verdana,Arial,Sans-Serif;
    font-size: 1.2em;
    text-transform: uppercase;
    margin: 0;
    padding: .5em 0 .4em;
  }

  #sidebar ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  #sidebar li:before {
    content: "\00BB  ";
  }

  a {
    color: #ff7010;
    text-decoration: none;
  }

  h1 {
    font-size 3.2em;
    line-height: 1em;
  }

  h2 {
    font-size: 1.8em;

  }

  h1, h2, h3, h4, h5 {
    font-family: 'Trebuchet MS', 'Lucida Grande', Verdana, Arial, Sans-Serif;
    font-weight: bold;
    line-height: normal;
    margin: 0;
    padding: 0;
  }

  small {
    font-size: 1em;
    line-height: 1.5em;
    background-color: inherit;
    color: #888;
  }

  h2.pagetitle {
    background-color: #f0f0f0;
    color: inherit;
    padding: 0.5em 0 0.4em 0.2em;
    margin: 0 0 2em 0;
  }

  #content {
    color: #484848;
  }

  .leftnav {
    float: left;
    margin: 0 1em 0;
  }

  .rightnav {
    float: right;
  }

  .snap-to-fit {
    clear: both;
    visibility: hidden;
  }

  .navigation {
    margin: 0 0 1.6em 0;
    padding: 0 0 1px 0;
    font-family: 'Lucida Grande', Arial, Verdana, Sans-Serif;
    font-size: 1.2em;
  }

  .post {
    margin: 0 0 3em;
  }

  .post+.post h2 {
      padding: .2em 0 0;
      border-top: 1px solid #888;
  }

  .entry {
    width: 100%;
    font-size: 1.2em;
    margin: 1em 0 0;
    overflow: auto;
  }

  #footer {
    clear: both;
    margin: 4em 0 1em;
    padding: .2em 0 0;
    border-top: 1px solid #888;
    font-family: lucida grande,Arial,Verdana,Sans-Serif;
  }


</style>

</head>

<body><div id="navbar-top" class="d-md-none">
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
	<a class="navbar-brand" href="/">Posts</a>
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
	  <span class="navbar-toggler-icon"></span>
	</button>
	<div class="collapse navbar-collapse" id="navbarNavAltMarkup">
	  <div class="navbar-nav">
            
              <a class="nav-item nav-link" href=/page/paragliding/>Paragliding Logbook</a>
            
              <a class="nav-item nav-link" href=/page/bucketlist/>The Bucket List</a>
            
              <a class="nav-item nav-link" href=/page/about/>About Me</a>
            
	  </div>
	</div>
      </nav>
    </div>


    <div class="container" id="container">
      
      <div class="row">
        <div class="col-md-9 offset-md-3">
          <div class="header">
            <h1><a href="/">Scott O&#39;Brien</a></h1>
            <small>Ramblings and resources of my online life</small>
          </div>
        </div> 
      </div>

      <div class="row">
        
        <div id="content" class="col-md-9">
          



<div class="navigation">
  <div class="leftnav">« <a href="/page/2/">Later Posts</a></div>
  <div class="snap-to-fit"></div>
</div>



  <div class="post">
    <h2 class="post__title">
      <a href="https://www.scottyob.com/2012/12/08/my-experiences-of-managing-a-cisco-switch-with-puppet/">My experiences of managing a Cisco switch with Puppet</a>
    </h2>
    <small>2012-12-08 12:19:41 &#43;0000 &#43;0000</small>
    <div class="entry">
      <p>One recent pet gripe of mine has been having to add a new VLAN into our datacenter for our vSphere platform.  Not that I trust my DCs switches with puppet just yet, this is a proof of concept post about how we could be using puppet to centrally manage this configuration and push it out across our DC.</p>
<p>**</p>
<p>Before</p>
<p>** We’ve got a pretty basic topology going on in our DC, it’s just a VSS with the other switches pretty much being nothing more but layer 2 for the most part.  The dot1q trunk back to the VSS carries all VLANs from our end of rack switches.  When we add a new vlan in the DC to trunk to the ESX machines, we would add the VLAN in all the DC switches (not running VTP) then add the vlan to the trunk port on each port patched to the ESX hosts.  (we’re not using any link aggregation to the ports connected to the same ESX host, the ESX hosts themselves have their own load balancing method.. If you know any for/against doing it like this please comment and let me know)</p>
<h3 id="heading"></h3>
<h3 id="setting-up-the-puppet-lab"><strong>Setting up the Puppet lab</strong></h3>
<p>****Introduced in Puppet 2.7 is <a href="http://puppetlabs.com/blog/puppet-network-device-management/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://puppetlabs.com']);">network device management</a>.  This more or less is an expect script to manage interfaces and vlans on IOS devices.  For this lab, we will be using cisco IOU with the following topology</p>
<p><a href="http://www.scottyob.com/wp-content/uploads/2012/12/IOU-Web-Interface-Laboratories.jpg" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.scottyob.com']);"><img class="aligncenter size-full wp-image-221" title="IOU Web Interface - Laboratories" alt="" src="http://www.scottyob.com/wp-content/uploads/2012/12/IOU-Web-Interface-Laboratories.jpg" width="507" height="319" /></a></p>
<h4 id="setting-up-the-devices">Setting up the Devices</h4>
<p>Ideally, you would have a few puppet nodes that manage a few devices each to spread out the load, for the purposes of this exercise, I created a single vm running Centos6 with both puppet-server and puppet installed.  For this machine to manage the switches, I added the following into the device.conf file</p>
<pre><code class="language-[root@localhost">[dc_sw1]
  type cisco
  url telnet://puppet:cisco@10.0.1.131/
[dc_sw2]
  type cisco
  url telnet://puppet:cisco@10.0.1.132/
[dc_sw3]
  type cisco
  url telnet://puppet:cisco@10.0.1.133/
[dc_sw4]
  type cisco
  url telnet://puppet:cisco@10.0.1.134/
</code></pre>
<h3 id="signing-the-devices">Signing the devices</h3>
<p>To update the devices, you have to run <strong>puppet device</strong>.  The first time you run it, a certificate will be created that needs to be signed on the puppet master.</p>
<pre><code class="language-[root@localhost">info: starting applying configuration to dc_sw4 at telnet://puppet:cisco@10.0.1.134/
info: Creating a new SSL key for dc_sw4
warning: peer certificate won't be verified in this SSL session
info: Caching certificate for ca
warning: peer certificate won't be verified in this SSL session
warning: peer certificate won't be verified in this SSL session
info: Creating a new SSL certificate request for dc_sw4
info: Certificate Request fingerprint (md5): E8:A6:35:9D:BF:CE:3D:BC:E0:E4:C2:5B:00:CE:9F:DB
warning: peer certificate won't be verified in this SSL session
warning: peer certificate won't be verified in this SSL session
warning: peer certificate won't be verified in this SSL session
</code></pre>
<p>so we’ll need to sign our devices</p>
<pre><code class="language-[root@localhost">notice: Signed certificate request for dc_sw4
notice: Removing file Puppet::SSL::CertificateRequest dc_sw4 at '/var/lib/puppet/ssl/ca/requests/dc_sw4.pem'
</code></pre>
<h3 id="setting-up-the-switches-for-puppet">Setting up the switches for Puppet</h3>
<p>If you look up to the device configuration file, we need to create a local user for puppet to log into the switch (remember, it acts much like an expect script)</p>
<pre><code class="language-username">line vty 0 4
 privilege level 15
 password cisco
 login local
 transport input all
!
</code></pre>
<h3 id="the-configuration">The Configuration</h3>
<p>so with no more ado, we can easily simply abstract the behaviour of these ports using puppet syntax 🙂</p>
<pre><code class="language-define">
        interface {
                &quot;${port}&quot;:
                        mode =&amp;gt; trunk,
                        duplex =&amp;gt; full,
                        description =&amp;gt; &quot;ESX Host&quot;,
                        allowed_trunk_vlans =&amp;gt; &quot;3,4,5,8,9&quot;
        }

}

node &quot;dc_sw1&quot; {

        esxport { 'e0/2': port =&amp;gt; 'Ethernet0/2' }
        esxport { 'e0/3': port =&amp;gt; 'Ethernet0/3' }

}

node &quot;dc_sw2&quot; {

        esxport { 'e1/0': port =&amp;gt; 'Ethernet1/0' }
        esxport { 'e1/1': port =&amp;gt; 'Ethernet1/1' }
        esxport { 'e1/2': port =&amp;gt; 'Ethernet1/2' }
        esxport { 'e1/3': port =&amp;gt; 'Ethernet1/3' }

}
</code></pre>
<h4 id="the-ugly">The Ugly</h4>
<p>A lot of the states don’t yet seem to be supported by this module.  This means even the default trunk mode of dynamic desirable will cause issues when Puppet is pulling device information and you’ll have to manually specify “switchport trunk encapsulation dot1q” and “switchport mode access” before setting puppet free on the devices.</p>
<h4 id="results">Results</h4>
<pre><code class="language-[root@localhost">info: starting applying configuration to dc_sw4 at telnet://puppet:cisco@10.0.1.134/
info: Caching catalog for dc_sw4
info: Applying configuration version '1355007108'
notice: Finished catalog run in 0.20 seconds
info: starting applying configuration to dc_sw3 at telnet://puppet:cisco@10.0.1.133/
info: Caching catalog for dc_sw3
info: Applying configuration version '1355007108'
notice: Finished catalog run in 0.21 seconds
info: starting applying configuration to dc_sw2 at telnet://puppet:cisco@10.0.1.132/
info: Caching catalog for dc_sw2
info: Applying configuration version '1355007108'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/1]/Interface[Ethernet1/1]/description: defined 'description' as 'ESX Host'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/1]/Interface[Ethernet1/1]/duplex: duplex changed 'auto' to 'full'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/1]/Interface[Ethernet1/1]/mode: mode changed 'access' to 'trunk'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/1]/Interface[Ethernet1/1]/allowed_trunk_vlans: defined 'allowed_trunk_vlans' as '3,4,5,8,9'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/3]/Interface[Ethernet1/3]/description: defined 'description' as 'ESX Host'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/3]/Interface[Ethernet1/3]/duplex: duplex changed 'auto' to 'full'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/3]/Interface[Ethernet1/3]/mode: mode changed 'access' to 'trunk'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/3]/Interface[Ethernet1/3]/allowed_trunk_vlans: defined 'allowed_trunk_vlans' as '3,4,5,8,9'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/2]/Interface[Ethernet1/2]/description: defined 'description' as 'ESX Host'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/2]/Interface[Ethernet1/2]/duplex: duplex changed 'auto' to 'full'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/2]/Interface[Ethernet1/2]/mode: mode changed 'access' to 'trunk'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/2]/Interface[Ethernet1/2]/allowed_trunk_vlans: defined 'allowed_trunk_vlans' as '3,4,5,8,9'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/0]/Interface[Ethernet1/0]/description: defined 'description' as 'ESX Host'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/0]/Interface[Ethernet1/0]/duplex: duplex changed 'auto' to 'full'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/0]/Interface[Ethernet1/0]/mode: mode changed 'access' to 'trunk'
notice: /Stage[main]//Node[dc_sw2]/Esxport[e1/0]/Interface[Ethernet1/0]/allowed_trunk_vlans: defined 'allowed_trunk_vlans' as '3,4,5,8,9'
notice: Finished catalog run in 14.22 seconds
</code></pre>
<h3 id="my-002">my $0.02</h3>
<p>I must say, I’m very disappointed in this module so far.  It shows great promise and makes a once tedious task relatively effortless to manage, however with the time invested to find out what is and what is not supported, I think it’s far too early to invest in such a solution.  The idea of setting something like an expect script loose on my kit also worries me.  It’s much better to have an API or a promise that the input/output the expect script uses won’t change in a future release then do something unexpected (pun intended there.)</p>
<p>I guess if we were using an OS like Junos we could have <a href="http://www.swarm-logic.com/content/quick-way-configure-interface-ranges-juniper-switches-junos-tips" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.swarm-logic.com']);">created apply-groups like this</a> to abstract the configuration in much the same manner, at least down to the switch level.  Very interesting for a new take on managing these things though</p>
<h2 id="span-stylecolor-ff6600editspan"><span style="color: #ff6600;">EDIT:</span></h2>
<p>I’ve been thinking about this a lot since I posted it.  I think I was too harsh on the tool.  It seems even Cisco’s own tools work by ssh’ing into the box to make their changes.. while not ideal, for these old IOS devices around, it seems to be the accepted thing to do.  It’s exciting times ahead in this space though, I can feel it!</p>
    </div>
  </div>

  <div class="post">
    <h2 class="post__title">
      <a href="https://www.scottyob.com/2012/11/08/address-book-for-a-the-blind/">Address Book For the Blind</a>
    </h2>
    <small>2012-11-09 00:32:51 &#43;0000 &#43;0000</small>
    <div class="entry">
      <p>This article is about using the <a href="http://www.asterisk.org" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.asterisk.org']);">Asterisk PBX</a> and exploiting <a href="http://www.google.com/insidesearch/features/voicesearch/index.html" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.google.com']);">Google’s voice recognition </a>API built for voice search in Chrome to build an address book that technology inept people (my grandmother) can use to place cheap telephone calls over VoIP.</p>
<p>This tool is built for my grandmother; a lady who has <a href="http://www.mdfoundation.com.au" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.mdfoundation.com.au']);">macular degeneration</a> making her legally blind.  She doesn’t want to invest a great deal of money in this solution or have much of a learning curve, it took long enough to get her using the two button audio book solution on the iPod.  </p>
<p>The basic idea is to purchase a direct inward dialing (DID) number and program it into her speed dial, this will connect to an Asterisk virtual machine that will launch the voice recognition to listen to who she wants to dial, look up the number in her address book then connect the call through, all at the rate of about $0.11 for a national call (actually saving her money!).</p>
<p>I’m using the <a href="http://zaf.github.com/asterisk-speech-recog/" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://zaf.github.com']);">Speech Recognition for Asterisk</a> module to convert the spoken recording to a string.  The problem with the method using this library for an address books is different words being returned that are pronounced very similar to the names in the book, for instance trying to find the name ‘elmer’ returned ‘Alma’.  With a bit of python scripting to use <a href="http://www.doughellmann.com/articles/how-tos/phonetic-hashing/index.html" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.doughellmann.com']);">fuzzy matching to search by sound with python</a> we can start to compare what our speech recognition engine returned with what we actually have in our address book. It must be noted that this method only works for a small set of different numbers in an address book, which although fits my grandmother fine, I plan to script the server so I can always make that magic button (DID speed dial) re-direct the call to anywhere I like.</p>
<pre><code class="language-&gt;&gt;&gt;">&amp;gt;&amp;gt;&amp;gt; dmetaphone = fuzzy.DMetaphone(3)
&amp;gt;&amp;gt;&amp;gt; dmetaphone('Alma')
['ALM', None]
&amp;gt;&amp;gt;&amp;gt; dmetaphone('Elmer')
['ALM', None]
&amp;gt;&amp;gt;&amp;gt; dmetaphone('Toss')
['TS', None]
&amp;gt;&amp;gt;&amp;gt; dmetaphone('Scott')
['SKT', None]
&amp;gt;&amp;gt;&amp;gt; dmetaphone('Troy')
['TR', None]
&amp;gt;&amp;gt;&amp;gt; dmetaphone('Sue')
['S', None]
&amp;gt;&amp;gt;&amp;gt; dmetaphone('Janet')
['JNT', 'ANT']
</code></pre>
<p>So, to execute the plan, I’m using an account on <a href="https://www.mynetfone.com.au" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.mynetfone.com.au']);">Mynetfone</a>.  The extensions.conf has a script to answer the call on my purchased DID, prompt for who she wants to talk to, run it through speech recognition, then call the number in her address book through a python script.  The extensions.conf that makes this magic happen looks like this:</p>
<pre><code class="language-[MyNetFone]">; Phone call is made to the service, welcome user and get their speech
exten =&amp;gt; 0920xxxx,1,Answer()
exten =&amp;gt; 0920xxxx,1,Wait(2)
exten =&amp;gt; 0920xxxx,n,agi(googletts.agi, &quot;Hello Miss Duckworth&quot;, en)
exten =&amp;gt; 0920xxxx,n,agi(googletts.agi, &quot;I am here to attempt to make your social life easier.&quot;, en)
exten =&amp;gt; 0920xxxx,n(intro),agi(googletts.agi, &quot;Who would you like to talk to?&quot;, en)
exten =&amp;gt; 0920xxxx,n,agi(speech-recog.agi, en-US)

; Look up number in address book, write debug information then go to the required section
exten =&amp;gt; 0920xxxx,n,agi(address-book.agi,${utterance})
exten =&amp;gt; 0920xxxx,n,Verbose(1,The text you just said is: ${utterance})
exten =&amp;gt; 0920xxxx,n,Verbose(1,The probability to be right is: ${confidence})
exten =&amp;gt; 0920xxxx,n,Verbose(1, ${foundname})
exten =&amp;gt; 0920xxxx,n,Verbose(1, ${todial})
exten =&amp;gt; 0920xxxx,n,GotoIf($[&quot;${foundname}&quot; = &quot;1&quot;]?success:fail)

; Name not found in the address book
exten =&amp;gt; 0920xxxx,n(fail),agi(googletts.agi,&quot;Sorry, I could not find the person ${utterance} in the address book&quot;, en)
exten =&amp;gt; 0920xxxx,n,agi(googletts.agi, &quot;Please feel free to try again&quot;,en)
exten =&amp;gt; 0920xxxx,n,Goto(intro)

; Connect the user through the MyNetFone service.
exten =&amp;gt; 0920xxxx,n(success),agi(googletts.agi, &quot;Please hold while I connect you to&quot;, en)
exten =&amp;gt; 0920xxxx,n,agi(googletts.agi, &quot;${utterance}&quot;, en)
exten =&amp;gt; 0920xxxx,n,Dial(SIP/MyNetFone/${todial}, 30)
exten =&amp;gt; 0920xxxx,n,Hangup()
</code></pre>
<p>and the python script address-book.agi file:</p>
<pre><code class="language-#!/usr/bin/python">
import sys
import fuzzy

# Read and ignore AGI environment (read until blank line)

addressBook = {
   'scott': '0415xxxxxx',
   'susan': '98xxxxxx',
   'support': '181'
}

dmetaphone = fuzzy.DMetaphone(3)

env = {}
tests = 0;

while 1:
   line = sys.stdin.readline().strip()

   if line == '':
      break
   key,data = line.split(':')
   if key[:4] &amp;lt;&amp;gt; 'agi_':
      #skip input that doesn't begin with agi_
      sys.stderr.write(&quot;Did not work!\n&quot;);
      sys.stderr.flush()
      continue
   key = key.strip()
   data = data.strip()
   if key &amp;lt;&amp;gt; '':
      env[key] = data

spokenWord = dmetaphone(env['agi_arg_1'])

for name in addressBook:
   if dmetaphone(name) == spokenWord:
      print 'SET VARIABLE todial &quot;%s&quot;' % addressBook[name]
      print 'SET VARIABLE foundname &quot;1&quot;'
      sys.exit(0)
print 'SET VARIABLE foundname &quot;0&quot;'
</code></pre>
    </div>
  </div>

  <div class="post">
    <h2 class="post__title">
      <a href="https://www.scottyob.com/2012/07/31/zfs-and-apple-time-machine-a-perfect-team/">ZFS and Apple Time Machine, a perfect team</a>
    </h2>
    <small>2012-07-31 12:09:51 &#43;0000 &#43;0000</small>
    <div class="entry">
      <p>So lately I’ve been thinking about my backup strategy on my Mac. From previous posts you might know I’ve build my OpenIndiana ZFS FileServer. Well, just created a volume and decided to put 300GB to good use to create a time machine on my mac. There is a brilliant guide on how to do it <a href="http://marcoschuh.de/wp/?p=494" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://marcoschuh.de']);">here</a> and suggest you all take a look (Thanks for the awesome guide Marco).</p>

    </div>
  </div>

  <div class="post">
    <h2 class="post__title">
      <a href="https://www.scottyob.com/2012/07/09/monitoring-srx-chassis-cluster/">Monitoring SRX Chassis Cluster</a>
    </h2>
    <small>2012-07-09 04:44:35 &#43;0000 &#43;0000</small>
    <div class="entry">
      <p>Just finishing off a few things at work this week.  We’ve got a few sites around the place where we have HA internet powered by two Juniper SRX100’s.  The Two SRX100’s operate in a Chassis Cluster and peer with our ISP using BGP across both active/passive devices.</p>
<p><a href="http://www.scottyob.com/wp-content/uploads/2012/07/check_srx_cluster.txt" onclick="javascript:_gaq.push(['_trackEvent','outbound-article','http://www.scottyob.com']);">This script</a> is a little Nagios check script that I wrote to hook into our in-house Nagios monitoring platform.  It makes sure the chassis cluster has not failed over operating in a degraded state, and makes sure that there are two BGP peers connected.</p>
<p>NOTE:  I was aiming for simplicity in this setup, if you’ve got a bigger environment or require instant notifications you might wish to set up snmp traps to get instant notifications.</p>
<pre><code class="language-#!/bin/bash">
# Bash script to check the status of a SRX cluster.
#  Works by SSHing into cluster to check &quot;show chassis cluster status&quot; command and SNMP walking to make sure BGP peers
#  are both in a connected state

STATE_OK=0
STATE_WARNING=1
STATE_CRITICAL=2
STATE_UNKNOWN=3

clusterAddress=$1
privateKey=$2
clusterStatus=`ssh nagios@$clusterAddress -i $privateKey &quot;show chassis cluster status&quot;`

declare -i primaryCount
declare -i secondaryCount
declare -i failoverCount
declare -i activeBgpPeers

activeBgpPeers=`snmpwalk -Os -c public -v 1 $clusterAddress .1.3.6.1.2.1.15.3.1.2 | grep &quot;INTEGER: 6&quot; | wc -l`
primaryCount=`echo &quot;$clusterStatus&quot; | grep primary | wc -l`
secondaryCount=`echo &quot;$clusterStatus&quot; | grep secondary | wc -l`
failoverCount=`echo &quot;$clusterStatus&quot; | grep &quot;Failover count: 0&quot; | wc -l`

if [ $primaryCount -ne 2 ]
then
        echo &quot;No two primary redundancy groups&quot;
		echo &quot;$clusterStatus&quot;
        exit $STATE_CRITICAL
fi

if [ $secondaryCount -ne 2 ]
then
        echo &quot;No two secondary redundancy groups&quot;
		echo &quot;$clusterStatus&quot;
        exit $STATE_CRITICAL
fi

if [ $failoverCount -ne 2 ]
then
        echo &quot;SRX has fallen over on a redundancy group&quot;
		echo &quot;$clusterStatus&quot;
        exit $STATE_WARNING
fi

if [ $activeBgpPeers -ne 2 ]
then
        echo &quot;NOT 2 Active BGP Peers&quot;
        exit $STATE_CRITICAL
fi

echo &quot;OK, 2 peers.  OK: Chassis Cluster status OK&quot;
echo &quot;$clusterStatus&quot;
exit $STATE_OK
</code></pre>
<p> </p>

    </div>
  </div>



<div class="navigation">
  <div class="rightnav"><a href="/page/4/">Earlier Posts</a> »</div>
  <div class="snap-to-fit"></div>
</div>


<div id="footer">
  Made with <a href="https://gohugo.io/">Hugo</a>.  Theme half-milk inspired by <a href="http://thortz.com/skimmed-milk/">skimmed-milk</a>
</div>
</div>
        <div id="sidebar" class="col-md-3 order-md-first d-none d-md-block">
          
          <h2>Other Pages</h2>
          <ul>
            
              <li><a href=/page/paragliding/>Paragliding Logbook</a></li>
            
              <li><a href=/page/bucketlist/>The Bucket List</a></li>
            
              <li><a href=/page/about/>About Me</a></li>
            
          </ul>
        </div> 
      </div> 
    </div> 
  </body>
</html>
